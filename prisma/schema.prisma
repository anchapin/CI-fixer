
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}


model AgentRun {
  id        String   @id @default(uuid())
  groupId   String
  status    String   // "working", "success", "failed", "stopped"
  state     String   // JSON string of AgentState
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fileModifications FileModification[]
  errorFacts        ErrorFact[]
  metrics           AgentMetrics[]
  fixAttempts       FixAttempt[]
  rewardSignals     RewardSignal[]
}

model FileModification {
  id         String   @id @default(uuid())
  path       String
  runId      String
  beforeContent String?
  afterContent  String?
  diff          String?
  agentRun   AgentRun @relation(fields: [runId], references: [id])
  createdAt  DateTime @default(now())
}

model ErrorFact {
  id           String   @id @default(uuid())
  summary      String
  filePath     String
  fixAction    String   // "edit" or "command"
  runId        String
  agentRun     AgentRun @relation(fields: [runId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // State tracking
  status       String   @default("open") // "open", "in_progress", "resolved", "blocked"
  
  // Agent notes for context preservation
  notes        String?  // JSON: { decisions: [], attempts: [], blockers: [] }
  
  // Relationships
  blockedBy    ErrorDependency[] @relation("BlockedErrors")
  blocking     ErrorDependency[] @relation("BlockingErrors")
  
  @@index([status])
  @@index([runId, status])
}

// ============================================================================
// METRICS COLLECTION
// ============================================================================

model AgentMetrics {
  id             String   @id @default(uuid())
  runId          String
  agentRun       AgentRun @relation(fields: [runId], references: [id])
  successRate    Float    // 0.0 - 1.0
  iterationCount Int
  timeToFixMs    Int      // Total time in milliseconds
  errorCategory  String   // From ErrorCategory enum
  createdAt      DateTime @default(now())
}

model FixAttempt {
  id           String   @id @default(uuid())
  runId        String
  agentRun     AgentRun @relation(fields: [runId], references: [id])
  iteration    Int
  action       String   // "edit", "command", "web_search", etc.
  success      Boolean
  durationMs   Int
  filesChanged String   // JSON array
  createdAt    DateTime @default(now())
  
  // ToolOrchestra: Multi-objective metrics
  llmCost         Float    @default(0)      // API cost in USD
  totalLatency    Int      @default(0)      // Wall-clock time in ms
  llmTokensInput  Int      @default(0)      // Input tokens
  llmTokensOutput Int      @default(0)      // Output tokens
  toolCallCount   Int      @default(0)      // Number of tool invocations
  toolsUsed       String?                   // JSON array of tool names
  codeQuality     Float?                    // Lint score (0-100)
  diffSize        Int?                      // Lines changed
  reward          Float?                    // Calculated composite reward
  modelUsed       String?                   // Which model was used
}

// ============================================================================
// HISTORICAL LEARNING
// ============================================================================

model FixPattern {
  id               String   @id @default(uuid())
  errorFingerprint String   // Hash of error characteristics
  errorCategory    String
  filePath         String
  fixTemplate      String   // JSON: { action, command?, edits? }
  successCount     Int      @default(1)
  lastUsed         DateTime @default(now())
  createdAt        DateTime @default(now())
  
  @@index([errorFingerprint])
  @@index([errorCategory])
}

model ErrorSolution {
  id                String   @id @default(uuid())
  errorFingerprint  String
  solution          String   // Detailed fix description
  filesAffected     String   // JSON array
  commandsUsed      String   // JSON array
  successRate       Float
  timesApplied      Int      @default(0)
  avgIterations     Float
  createdAt         DateTime @default(now())
  
  @@index([errorFingerprint])
}

// ============================================================================
// SUGGESTED ACTION LIBRARY
// ============================================================================

model ActionTemplate {
  id              String   @id @default(uuid())
  errorCategory   String
  filePattern     String   // e.g., "*.ts", "package.json"
  actionType      String   // "install_deps", "fix_syntax", "add_import"
  template        String   // Command or edit template
  frequency       Int      @default(0)
  successRate     Float    @default(0.0)
  lastUsed        DateTime @default(now())
  createdAt       DateTime @default(now())
  
  @@index([errorCategory, filePattern])
}

// ============================================================================
// DEPENDENCY TRACKING
// ============================================================================

model ErrorDependency {
  id              String   @id @default(uuid())
  sourceErrorId   String   // The error that depends on another
  targetErrorId   String   // The error that must be resolved first
  relationshipType String  // "blocks", "discovered_from", "related", "parent_child"
  createdAt       DateTime @default(now())
  metadata        String?  // JSON: additional context about the relationship
  
  sourceError     ErrorFact @relation("BlockedErrors", fields: [sourceErrorId], references: [id])
  targetError     ErrorFact @relation("BlockingErrors", fields: [targetErrorId], references: [id])
  
  @@index([sourceErrorId])
  @@index([targetErrorId])
  @@index([relationshipType])
}

// ============================================================================
// CROSS-RUN ERROR CLUSTERING
// ============================================================================

model ErrorCluster {
  id               String   @id @default(uuid())
  fingerprint      String   @unique // Hash of error characteristics
  category         String
  occurrenceCount  Int      @default(1)
  firstSeen        DateTime @default(now())
  lastSeen         DateTime @default(now())
  errorFactIds     String   // JSON array of ErrorFact IDs
  commonPattern    String?  // Extracted common pattern
  
  @@index([fingerprint])
  @@index([category])
}

// ============================================================================
// TOOLORCHESTRA: USER PREFERENCES & TRAJECTORY OPTIMIZATION
// ============================================================================

model RepositoryPreferences {
  id          String   @id @default(uuid())
  repoUrl     String   @unique
  preferences String                  // JSON preferences object
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FixTrajectory {
  id              String   @id @default(uuid())
  errorCategory   String
  complexity      Int
  toolSequence    String                    // JSON array of tool names
  success         Boolean
  totalCost       Float
  totalLatency    Int
  reward          Float
  occurrenceCount Int      @default(1)
  createdAt       DateTime @default(now())
  lastUsed        DateTime @default(now())
  
  @@index([errorCategory, complexity])
  @@index([success])
}

// ============================================================================
// AUTO-LEARNING & REINFORCEMENT LEARNING
// ============================================================================

model IngestedData {
  id        String   @id @default(uuid())
  source    String   // e.g., "benchmark_log.txt", "SWE-bench"
  type      String   // "log", "diff", "external"
  content   String   // actual content or path
  metadata  String?  // JSON
  createdAt DateTime @default(now())
}

model RewardSignal {
  id        String   @id @default(uuid())
  runId     String
  agentRun  AgentRun @relation(fields: [runId], references: [id])
  outcome   String   // "Pass", "Fail"
  reward    Float
  createdAt DateTime @default(now())
}

model LearningMetric {
  id         String   @id @default(uuid())
  metricName String   // "Fix Rate", "False Positive Rate", etc.
  value      Float
  timestamp  DateTime @default(now())
  metadata   String?  // JSON
}

// ============================================================================
// PATH VERIFICATION TELEMETRY
// ============================================================================

model PathCorrection {
  id              String   @id @default(uuid())
  originalPath    String   // The path the agent tried to use
  correctedPath   String   // The actual path that was used
  filename        String   // The basename of the file
  toolName        String   // "read_file", "write_file", "runCmd", etc.
  agentRunId      String?  // Optional: Link to agent run if available
  createdAt       DateTime @default(now())

  @@index([toolName])
  @@index([filename])
  @@index([createdAt])
}
